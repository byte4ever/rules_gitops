# Kustomize Extension

The `skylib/kustomize/` directory provides two things:

1. A **module extension** that downloads the kustomize binary for your platform
2. **Build rules** that run kustomize to produce Kubernetes manifests

## Setup

Add to your `MODULE.bazel`:

```starlark
gitops = use_extension("@rules_gitops//skylib/kustomize:extensions.bzl", "gitops")
use_repo(gitops, "kustomize_bin")
```

This downloads kustomize and makes it available as `@kustomize_bin//:kustomize`.

## Kustomize Version

Version: **5.4.3**

Downloaded from the official kustomize GitHub releases.

## Supported Platforms

| Platform | Archive |
|----------|---------|
| macOS (Intel) | `kustomize_v5.4.3_darwin_amd64.tar.gz` |
| macOS (Apple Silicon) | `kustomize_v5.4.3_darwin_arm64.tar.gz` |
| Linux (x86_64) | `kustomize_v5.4.3_linux_amd64.tar.gz` |
| Linux (ARM64) | `kustomize_v5.4.3_linux_arm64.tar.gz` |

## Build Rules

The main build rules are defined in `kustomize.bzl`:

- **`kustomize`** -- Generates kustomization.yaml, runs `kustomize build`, pipes through template expansion and image resolution. Outputs a rendered `.yaml` file.
- **`kubectl`** -- Generates a shell script that optionally pushes images and runs `kubectl apply` or `delete`.
- **`gitops`** -- Generates a shell script that writes rendered manifests to a gitops directory tree.

These rules are not used directly -- they are generated by the `k8s_deploy` macro in `skylib/k8s.bzl`. See the [Starlark Rules Reference](../README.md) for full documentation.

## Providers

### KustomizeInfo

Carries image push statements between rules.

| Field | Description |
|-------|-------------|
| `image_pushes` | Depset of Files containing image push shell script fragments |
