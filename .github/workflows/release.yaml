name: Release

on:
  push:
    tags: ["*.*.*"]

jobs:
  validate:
    name: Validate Tag
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Check tag matches MODULE.bazel version
        run: |
          TAG="${GITHUB_REF_NAME}"
          MODULE_VERSION=$(grep -oP 'version = "\K[^"]+' MODULE.bazel | head -1)
          if [ "${TAG}" != "${MODULE_VERSION}" ]; then
            echo "Error: tag '${TAG}' does not match MODULE.bazel version '${MODULE_VERSION}'"
            exit 1
          fi
          echo "Tag ${TAG} matches MODULE.bazel version."

  lint-go:
    name: Lint Go
    needs: [validate]
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - name: Install golangci-lint
        run: go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@v2.1.6
      - name: golangci-lint
        run: golangci-lint run

  test-go:
    name: Test Go
    needs: [validate]
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - name: Run tests with coverage
        run: |
          go test -race -coverprofile=coverage.out -covermode=atomic ./...
      - name: Check coverage threshold
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | tr -d '%')
          echo "Total coverage: ${COVERAGE}%"
          if (( $(echo "${COVERAGE} < 35" | bc -l) )); then
            echo "Coverage ${COVERAGE}% is below threshold of 35%"
            exit 1
          fi

  buildifier:
    name: Buildifier
    needs: [validate]
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Install buildifier
        run: |
          TOOLS_DIR="${HOME}/.local/bin"
          mkdir -p "${TOOLS_DIR}"
          curl -Ls -o "${TOOLS_DIR}/buildifier" \
            "https://github.com/bazelbuild/buildtools/releases/download/v7.3.1/buildifier-linux-amd64"
          chmod +x "${TOOLS_DIR}/buildifier"
          echo "${TOOLS_DIR}" >> "${GITHUB_PATH}"
      - name: Check formatting
        run: |
          find . -type f \( \
            -name '*.bzl' \
            -o -name '*.sky' \
            -o -name BUILD \
            -o -name BUILD.bazel \
            -o -name MODULE.bazel \
          \) -not -path './inspiration/*' \
            -not -path './examples/*' \
          | xargs buildifier -mode=check -lint=warn \
            --warnings=-module-docstring,-function-docstring,-function-docstring-header,-function-docstring-args,-function-docstring-return,-print \
          || {
            echo "Error: buildifier check failed."
            exit 1
          }

  test-starlark:
    name: Test Starlark
    needs: [validate]
    runs-on: ubuntu-24.04
    env:
      USE_BAZEL_VERSION: "8.1.0"
    steps:
      - uses: actions/checkout@v4
      - name: Mount Bazel cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/bazel
          key: bazel-8-${{ github.sha }}
          restore-keys: |
            bazel-8-
      - name: Install Bazel
        run: |
          TOOLS_DIR="${HOME}/.local/bin"
          mkdir -p "${TOOLS_DIR}"
          curl -Ls -o "${TOOLS_DIR}/bazel" \
            "https://github.com/bazelbuild/bazelisk/releases/download/v1.25.0/bazelisk-linux-amd64"
          chmod +x "${TOOLS_DIR}/bazel"
          echo "${TOOLS_DIR}" >> "${GITHUB_PATH}"
      - name: Build
        run: bazel build //...
      - name: Test
        run: bazel test //...

  release:
    name: Create Release
    needs: [lint-go, test-go, buildifier, test-starlark]
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
